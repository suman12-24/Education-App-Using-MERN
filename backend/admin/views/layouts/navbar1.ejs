<!-- Navbar -->
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="index3.html" class="nav-link">Home</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link">Contact</a>
        </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
        <!-- Navbar Search -->
        <li class="nav-item">
            <a class="nav-link" data-widget="navbar-search" href="#" role="button">
                <i class="fas fa-search"></i>
            </a>
            <div class="navbar-search-block">
                <form class="form-inline">
                    <div class="input-group input-group-sm">
                        <input class="form-control form-control-navbar" type="search" placeholder="Search"
                            aria-label="Search">
                        <div class="input-group-append">
                            <button class="btn btn-navbar" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </li>

        <!-- Messages Dropdown Menu -->
        <li class="nav-item dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
                <i class="far fa-comments"></i>
                <span class="badge badge-danger navbar-badge">3</span>
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                <a href="#" class="dropdown-item">
                    <!-- Message Start -->
                    <div class="media">
                        <img src="/Template/dist/img/user1-128x128.jpg" alt="User Avatar"
                            class="img-size-50 mr-3 img-circle">
                        <div class="media-body">
                            <h3 class="dropdown-item-title">
                                Brad Diesel
                                <span class="float-right text-sm text-danger"><i class="fas fa-star"></i></span>
                            </h3>
                            <p class="text-sm">Call me whenever you can...</p>
                            <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
                        </div>
                    </div>
                    <!-- Message End -->
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">
                    <!-- Message Start -->
                    <div class="media">
                        <img src="/Template/dist/img/user8-128x128.jpg" alt="User Avatar"
                            class="img-size-50 img-circle mr-3">
                        <div class="media-body">
                            <h3 class="dropdown-item-title">
                                John Pierce
                                <span class="float-right text-sm text-muted"><i class="fas fa-star"></i></span>
                            </h3>
                            <p class="text-sm">I got your message bro</p>
                            <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
                        </div>
                    </div>
                    <!-- Message End -->
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">
                    <!-- Message Start -->
                    <div class="media">
                        <img src="/Template/dist/img/user3-128x128.jpg" alt="User Avatar"
                            class="img-size-50 img-circle mr-3">
                        <div class="media-body">
                            <h3 class="dropdown-item-title">
                                Nora Silvester
                                <span class="float-right text-sm text-warning"><i class="fas fa-star"></i></span>
                            </h3>
                            <p class="text-sm">The subject goes here</p>
                            <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
                        </div>
                    </div>
                    <!-- Message End -->
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item dropdown-footer">See All Messages</a>
            </div>
        </li>
        <!-- Notifications Dropdown Menu -->
        <li class="nav-item dropdown" id="notifications-dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
                <i class="far fa-bell"></i>
                <span class="badge badge-warning navbar-badge" id="notification-count">0</span>
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                <span class="dropdown-item dropdown-header" id="notification-header">0 New Notifications</span>
                <div class="dropdown-divider"></div>
                <div id="notification-list">
                    <!-- Notifications will be dynamically inserted here -->
                </div>
                <div class="dropdown-divider"></div>
                <a href="/admin/notifications" class="dropdown-item dropdown-footer">See All Notifications</a>
            </div>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                <i class="fas fa-expand-arrows-alt"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-widget="control-sidebar" data-controlsidebar-slide="true" href="#" role="button">
                <i class="fas fa-th-large"></i>
            </a>
        </li>
    </ul>
</nav>

<!-- Socket.IO client library -->
<script src="/socket.io/socket.io.js"></script>

<!-- WebSocket Notifications JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Connect to WebSocket server
        const socket = io();

        // Initial notification count and list
        let notifications = [];
        let unreadCount = 0;

        // Listen for admin room connection confirmation
        socket.emit('join_admin_room');

        // Listen for new school notifications
        socket.on('new_school_notification', function (notification) {
            console.log('New notification received:', notification);

            // Add notification to the beginning of the array
            notifications.unshift(notification);

            // Update unread count
            unreadCount++;

            // Update notification badge
            updateNotificationBadge();

            // Update notification dropdown
            updateNotificationDropdown();

            // Show notification toast (if you want a toast notification)
            showNotificationToast(notification);
        });

        // Function to update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-count');

            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }

            // Update header text
            document.getElementById('notification-header').textContent =
                unreadCount > 0 ? `${unreadCount} New Notifications` : 'No New Notifications';
        }

        // Function to update notification dropdown
        function updateNotificationDropdown() {
            const notificationList = document.getElementById('notification-list');

            // Clear existing notifications
            notificationList.innerHTML = '';

            // Show up to 5 most recent notifications
            const recentNotifications = notifications.slice(0, 5);

            if (recentNotifications.length === 0) {
                const emptyItem = document.createElement('a');
                emptyItem.href = '#';
                emptyItem.className = 'dropdown-item';
                emptyItem.innerHTML = '<p class="text-muted text-center my-2">No notifications</p>';
                notificationList.appendChild(emptyItem);
                return;
            }

            // Add notifications to dropdown
            recentNotifications.forEach(notification => {
                const notificationItem = document.createElement('a');
                notificationItem.href = `/admin/schools/${notification.schoolId}`;
                notificationItem.className = 'dropdown-item';

                // Format the timestamp
                const timestamp = new Date(notification.timestamp);
                const timeAgo = getTimeAgo(timestamp);

                notificationItem.innerHTML = `
            <i class="fas fa-school mr-2"></i> ${notification.message}
            <span class="float-right text-muted text-sm">${timeAgo}</span>
          `;

                // Mark as read when clicked
                notificationItem.addEventListener('click', function () {
                    markNotificationAsRead(notification._id);
                });

                notificationList.appendChild(notificationItem);

                // Add divider except after the last item
                if (notification !== recentNotifications[recentNotifications.length - 1]) {
                    const divider = document.createElement('div');
                    divider.className = 'dropdown-divider';
                    notificationList.appendChild(divider);
                }
            });
        }

        // Function to mark notification as read
        function markNotificationAsRead(notificationId) {
            // Find the notification in our array
            const index = notifications.findIndex(n => n._id === notificationId);

            if (index > -1) {
                // Update read status
                notifications[index].status = 'read';

                // Update server via API
                fetch(`/admin/api/notifications/${notificationId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Notification marked as read:', data);

                        // Decrement unread count
                        unreadCount--;

                        // Update UI
                        updateNotificationBadge();
                    })
                    .catch(error => {
                        console.error('Error marking notification as read:', error);
                    });
            }
        }

        // Function to show notification toast
        function showNotificationToast(notification) {
            // Check if Toast library is available (you can use Toastr or similar)
            if (typeof toastr !== 'undefined') {
                toastr.info(notification.message, 'New Registration');
            } else {
                // Create a simple toast notification if toastr is not available
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.innerHTML = `
            <div class="toast-header">
              <strong>New Registration</strong>
              <button type="button" class="close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
            </div>
            <div class="toast-body">
              ${notification.message}
            </div>
          `;

                // Apply some basic styles
                toast.style.position = 'fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.backgroundColor = 'white';
                toast.style.borderLeft = '4px solid #17a2b8';
                toast.style.padding = '10px';
                toast.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                toast.style.minWidth = '250px';
                toast.style.zIndex = '9999';

                // Add to DOM
                document.body.appendChild(toast);

                // Remove after 5 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 5000);
            }
        }

        // Helper function to format time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';

            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';

            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';

            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';

            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';

            if (seconds < 10) return 'just now';

            return Math.floor(seconds) + ' seconds ago';
        }

        // Fetch initial notifications when page loads
        fetch('/admin/api/notifications')
            .then(response => response.json())
            .then(data => {
                notifications = data.notifications || [];
                unreadCount = notifications.filter(n => n.status === 'unread').length;
                updateNotificationBadge();
                updateNotificationDropdown();
            })
            .catch(error => {
                console.error('Error fetching notifications:', error);
            });

        // Optionally add a manual refresh button
        /*
        document.getElementById('refresh-notifications').addEventListener('click', function() {
          fetch('/admin/api/notifications')
            .then(response => response.json())
            .then(data => {
              notifications = data.notifications || [];
              unreadCount = notifications.filter(n => n.status === 'unread').length;
              updateNotificationBadge();
              updateNotificationDropdown();
            });
        });
        */
    });
</script>
<!-- /.navbar -->